<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Missorts HUB — History Dashboard</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root{
      --bg:#0b1020; --txt:#e8ecff; --muted:#a8b1d6;
      --line:rgba(255,255,255,.08); --good:#38d39f; --poor:#ff5c7a; --wc:#7aa7ff;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1200px 800px at 20% 0%, #16245a 0%, var(--bg) 45%, #070a14 100%);
      color:var(--txt); font-family:var(--sans);
    }
    header{
      position:sticky; top:0; z-index:5;
      background: linear-gradient(to bottom, rgba(11,16,32,.92), rgba(11,16,32,.65));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .wrap{max-width:1280px; margin:0 auto; padding:18px 18px 22px;}
    .topbar{display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .title{display:flex; flex-direction:column; gap:2px;}
    .title h1{margin:0; font-size:18px; letter-spacing:.2px}
    .title .sub{color:var(--muted); font-size:12px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}
    .btn, select{
      background: rgba(255,255,255,.06);
      color: var(--txt);
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      font-size:12px;
      outline:none;
    }
    select{padding-right:30px}
    .btn{cursor:pointer; transition: transform .05s ease, background .15s ease; user-select:none;}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(122,167,255,.18); border-color: rgba(122,167,255,.35)}
    .btn.danger{background: rgba(255,92,122,.14); border-color: rgba(255,92,122,.35)}
    .btn.ghost{background: rgba(255,255,255,.04)}
    .hint{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:12px;}
    .badge{
      font-family: var(--mono);
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:6px 10px;
      border-radius: 999px;
    }
    main .wrap{padding-top:18px}
    .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px;}
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      overflow:hidden;
    }
    .card h2{margin:0 0 10px 0; font-size:13px; letter-spacing:.2px; color: #dbe3ff;}
    .kpi{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      padding:12px; border-radius: 14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
    }
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .value{font-size:18px; font-weight:700; letter-spacing:.2px; font-family:var(--mono)}
    .kpi .small{font-size:11px; color:var(--muted); font-family:var(--mono)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .pill b{color:var(--txt); font-family:var(--mono)}

    table{width:100%; border-collapse: collapse; font-size:12px;}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align: middle; white-space:nowrap;}
    th{text-align:left; color:var(--muted); font-weight:600; letter-spacing:.2px; font-size:11px; text-transform: uppercase;}
    td.num{font-family:var(--mono); text-align:right}
    .right{ text-align:right }
    .muted{color:var(--muted)}
    .band{font-size:11px; padding:4px 8px; border-radius:999px; display:inline-block; border:1px solid var(--line); background: rgba(255,255,255,.05); font-family: var(--mono);}
    .band.poor{border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.12); color:#ffd0d9}
    .band.good{border-color: rgba(56,211,159,.35); background: rgba(56,211,159,.10); color:#c8ffe9}
    .band.wc{border-color: rgba(122,167,255,.35); background: rgba(122,167,255,.12); color:#d7e6ff}
    .split{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
  gap:14px;
}
    .footnote{margin-top:10px; font-size:11px; color:var(--muted); line-height:1.4}
    .status{font-family: var(--mono); font-size:11px; color: var(--muted);}
    .dangerText{color:#ffb3c2}
    .goodText{color:#bfffe9}
    .wcText{color:#d7e6ff}
    .hr{height:1px; background: rgba(255,255,255,.08); margin:10px 0;}
    input.inline{
      width:100%;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      color:var(--txt);
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      outline:none;
    }

    /* Horizontal scroll tables + sticky first column */
    .tableWrap{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
    }
    .tableWrap{
  width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.06);
  background: rgba(0,0,0,.10);
}

/* default: tables should fit the card */
.tableWrap table{
  width:100%;
  min-width: 0;
}

/* only use this for genuinely wide tables */
.tableWrap.wide table{
  min-width: 1100px;
}

/* make scrollbars visible-ish (mac hides by default) */
.tableWrap::-webkit-scrollbar{ height: 10px; }
.tableWrap::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.18);
  border-radius: 999px;
}
    .stickyCol{
      position: sticky;
      left: 0;
      background: rgba(10,14,28,.92);
      backdrop-filter: blur(6px);
      z-index: 2;
    }
    .subline{
      color:var(--muted);
      font-size:12px;
      margin-top:-2px;
      margin-bottom:10px;
    }

    @media (max-width: 1100px){ .split{grid-template-columns: 1fr} }
    @media (max-width: 900px){ .grid{grid-template-columns: repeat(6, 1fr)} }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Missorts HUB — History Dashboard</h1>
        <div class="sub">Load from Google Sheet (RAW_DUMP published as CSV) → saved locally → switch Day/Week to view history</div>
      </div>
      <div class="controls">
        <button class="btn primary" id="btnLoadSheet">Load from GSheet</button>
        <select id="viewMode" title="View mode">
          <option value="day">Day view</option>
          <option value="week">Week view</option>
        </select>
        <select id="dateSelect" title="Pick a saved date"></select>
        <select id="weekSelect" title="Pick an ISO week"></select>
        <button class="btn ghost" id="btnRefresh">Refresh View</button>
        <button class="btn danger" id="btnWipe">Wipe All Saved Data</button>
      </div>
    </div>

    <div class="hint">
      <span class="badge" id="dbState">DB: …</span>
      <span class="badge" id="lastUpdated">Last updated: —</span>
      <span class="badge" id="datesState">Dates: 0</span>
      <span class="badge" id="rowsState">Rows: 0</span>
      <span class="badge" id="thresholdState">Thresholds: WC ≤ 0.005, Good ≤ 0.01</span>
      <span class="status" id="status">Ready.</span>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">

      <!-- ACTION LIST -->
      <div class="card" style="grid-column: span 12;">
        <h2>Top 5 Actions for Today</h2>
        <div class="subline">This is always based on the latest saved date in the database (not your selected view).</div>
        <div id="actionsList"></div>
        <div class="footnote">Owners & due dates are editable and saved locally in this browser. Actions update dynamically as your saved data changes.</div>
      </div>

      <div class="card" style="grid-column: span 12;">
        <h2 id="kpiTitle">KPIs</h2>
        <div class="subline" id="kpiSubtitle">—</div>
        <div class="row" id="kpiRow"></div>
        <div class="hr"></div>
        <div class="row" id="errorBreakdown"></div>
        <div class="footnote">
          Calculations are weighted by parcels: <span class="muted">Missort % = Total Errors / Total Parcels</span>.
          Banding uses thresholds (default): <span class="wcText">World Class ≤ 0.005</span>, <span class="goodText">Good ≤ 0.01</span>, else <span class="dangerText">Poor</span>.
        </div>
      </div>

      <div class="card" style="grid-column: span 6;">
        <h2>Top 10 WORST performers (by Missort %)</h2>
        <div id="worstTable"></div>
      </div>

      <div class="card" style="grid-column: span 6;">
        <h2>Top 10 BEST performers (by Missort %)</h2>
        <div id="bestTable"></div>
      </div>

      <div class="card" style="grid-column: span 12;">
        <h2>Top 10 by Error Category (counts) — current view</h2>
        <div class="split">
          <div>
            <div class="pill"><b>Error 1</b> — Top 10 contributors</div>
            <div id="e1Table" style="margin-top:10px"></div>
          </div>
          <div>
            <div class="pill"><b>Error 2</b> — Top 10 contributors</div>
            <div id="e2Table" style="margin-top:10px"></div>
          </div>
          <div>
            <div class="pill"><b>Error 3</b> — Top 10 contributors</div>
            <div id="e3Table" style="margin-top:10px"></div>
          </div>
          <div>
            <div class="pill"><b>Error 4</b> — Top 10 contributors</div>
            <div id="e4Table" style="margin-top:10px"></div>
          </div>
          <div style="grid-column: span 2;">
            <div class="pill"><b>Error 5</b> — Top 10 contributors</div>
            <div id="e5Table" style="margin-top:10px"></div>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: span 12;">
        <h2>Repeat Offenders (poor days + repeated error pattern)</h2>
        <div id="repeatTable"></div>
        <div class="footnote">
          This counts how many distinct days in the selected view window an operative was in the <span class="dangerText">Poor</span> band and shows which errors they repeat most on those poor days.
        </div>
      </div>

    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
/** =========================
 *  Google Sheet (Published CSV) — Option A
 *  ========================= */
const PUBLISHED_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRXmQA94ObKe3l0woMxKUsEVRWqd0u8TdWgfJwcIstgoCGF8TesRXbLO-sEc4X9EhJH7tJo4g4vp_ok/pub?gid=2003695004&single=true&output=csv";

/** =========================
 *  People directory (Email → Name)
 *  ========================= */
const PEOPLE = [
  {first:"Abdelrazak", last:"suldan", email:"azakn7@gmail.com"},
  {first:"Abdulnaie", last:"Salim", email:"hhs_abdul@hotmail.co.uk"},
  {first:"Abukar", last:"Ahmed", email:"abukara432@gmail.com"},
  {first:"Alaadin", last:"Alhamwi", email:"alaadin@hotmail.co.uk"},
  {first:"Almas", last:"Zazai", email:"almaszazai9@gmail.com"},
  {first:"Amila Inoka Herath", last:"Herath", email:"amila.herath@gmail.com"},
  {first:"Anura Tharanga", last:"Kumara", email:"aatkumara@gmail.com"},
  {first:"Anuruddhika Kumara", last:"Subharathna", email:"krishanlk@gmail.com"},
  {first:"Ashen", last:"Silva", email:"ashensilva42@gmail.com"},
  {first:"Ashraf", last:"Chowdhury", email:"accaashraf@yahoo.com"},
  {first:"Chamali", last:"Pramudika", email:"pramudihettiachchi@gmail.com"},
  {first:"Chamika", last:"Senarath", email:"chamika.ruwantha78@gmail.com"},
  {first:"Chamika", last:"Madushan", email:"chami.kawidanapathirana96@gmail.com"},
  {first:"Chaminda Kumara", last:"Mallawaarachchi", email:"chamindamallawaarachchi6@gmail.com"},
  {first:"Chamindu Lakshitha", last:"De Silva", email:"chamindulakshith9@gmail.com"},
  {first:"Chanaka Sandaruwan", last:"Perera", email:"sandaruwanchanaka471@gmail.com"},
  {first:"Chandana", last:"Don", email:"priyankara795@yahoo.com"},
  {first:"Chanupa", last:"Jayawardana", email:"chanupa320@gmail.com"},
  {first:"Chathura Nuwan", last:"Weerasinghe", email:"chathuranuwan540@gmail.com"},
  {first:"Darren", last:"Peter", email:"darrenjpeter@gmail.com"},
  {first:"Deepal", last:"Pushpakumara", email:"arunap20151989@gmail.com"},
  {first:"Dhananjaya Samarasingh", last:"Hewa Dewage", email:"tdhananjaya772@gmail.com"},
  {first:"Dilupa", last:"Dias", email:"diasdilupa@gmail.com"},
  {first:"Dulitha", last:"Pahasara", email:"dulitha.pahasara2006@gmail.com"},
  {first:"Ebony", last:"Christopher", email:"ebonymarkel1@gmail.com"},
  {first:"Elvis", last:"Prepah", email:"elvi3studio@gmail.com"},
  {first:"Eranga Priyanath", last:"Ariyawansha", email:"priyanatheranga@gmail.com"},
  {first:"Flocy Maline", last:"Almeida", email:"flocyalmeida@gmail.com"},
  {first:"Florentina", last:"Violeta Corchez", email:"florykok@gmail.com"},
  {first:"Gayan Kanchana Nilupul", last:"Dissanayake Mudiyanselage", email:"gaikanchana@gmail.com"},
  {first:"Haroon", last:"Dek", email:"haroondk@gmail.com"},
  {first:"Hasini", last:"Rathnasiri", email:"hasinirathnasiri@gmail.com"},
  {first:"Henrieta", last:"Urbancice Fikornova", email:"henula1986@gmail.com"},
  {first:"Heshan", last:"Rathnayake", email:"heshanpiyumantha9865@gmail.com"},
  {first:"Hiran Madushan", last:"Dharmarathna", email:"hirandharamarathana@gmail.com"},
  {first:"Ibrar", last:"Hanif", email:"ibrar482@icloud.com"},
  {first:"Imasha", last:"Ethugalage", email:"imashadilhara9494@gmail.com"},
  {first:"Indika", last:"Daswatta", email:"indika@daswatta.co.uk"},
  {first:"Jipson", last:"Yesudasan", email:"zainjipzon007@gmail.com"},
  {first:"Kaku", last:"Khanna", email:"mpff@hotmail.co.uk"},
  {first:"Kasun", last:"Hewage", email:"p.p.h.kasun.k@gmail.com"},
  {first:"Kasun", last:"Liyanage", email:"liyanage.kasun95@gmail.com"},
  {first:"Kaveen Anjula", last:"Kanaththage", email:"kaveenanjj10@gmail.com"},
  {first:"Kavith", last:"Harshana Senaratne", email:"kavith.harshana1@gmail.com"},
  {first:"KENNETH", last:"KAHAVITA ARACHCHIGE", email:"kenneth_rangana@yahoo.com"},
  {first:"Lalinda", last:"Jayathilaka", email:"lalinda94@proton.me"},
  {first:"Mansi", last:"Nehra", email:"mansinehra13g@gmail.com"},
  {first:"Marin", last:"Mariyanayagam", email:"nlmarin@yahoo.co.uk"},
  {first:"Mikiel", last:"Bruce", email:"m.donavon@outlook.com"},
  {first:"Milan", last:"Sinhallage", email:"smdevinda@gmail.com"},
  {first:"MOHAMMED SHAFEEH KARI VADAKE", last:"THODI", email:"shafeeh07@gmail.com"},
  {first:"Mudhitha Kanchana", last:"Bandara", email:"mudithapabc@gmail.com"},
  {first:"Muhammad", last:"Tanveer", email:"hamzatanveer98@gmail.com"},
  {first:"Nadesh Sameera", last:"Perera", email:"nadesshameera@yahoo.co.uk"},
  {first:"Najat", last:"Omar", email:"najatmohammed70@gmail.com"},
  {first:"Naveen", last:"Dileesha", email:"dileesha077@gmail.com"},
  {first:"Neel", last:"Baldevbhai Patel", email:"neel80265@gmail.com"},
  {first:"Niranjana Senani", last:"Jansen", email:"niranjanasenani@gmail.com"},
  {first:"Pawandeep", last:"Kaur", email:"deeppawan295@gmail.com"},
  {first:"Prasad", last:"Kaluarachchi", email:"prasadkaul01@gmail.com"},
  {first:"Prasanna Janaka", last:"Don", email:"akith.don@gmail.com"},
  {first:"Prince Rajendra", last:"Patil", email:"patelprince1098@gmail.com"},
  {first:"Rasika", last:"Mevantoo De Silva", email:"mewantzoo@gmail.com"},
  {first:"Rathika Vidarshana", last:"Perera", email:"rathika.vidarshana.rv@gmail.com"},
  {first:"Raveen Randika", last:"Rathnasinghe", email:"rathnasinghe06@gmail.com"},
  {first:"Richard", last:"Amayke", email:"richardamakye16@gmail.com"},
  {first:"Rishitha Melan", last:"Banda", email:"bandaramelan3@gmail.com"},
  {first:"Sajana Kalinda", last:"Sangasinghe", email:"sksajana97@gmail.com"},
  {first:"Sameera", last:"Ekanayaka", email:"nuwangetamanna@gmail.com"},
  {first:"Samidu", last:"Edirisinghe", email:"samiedirisinghe@gmail.com"},
  {first:"Sampath", last:"Mudiyanselage", email:"sampath71000@gmail.com"},
  {first:"Sarath", last:"Premachandra", email:"spremachandra53@gmail.com"},
  {first:"Shanith Chathuranga", last:"Yoda Pedige", email:"shenithchathuranga@gmail.com"},
  {first:"Tharaka", last:"Herath", email:"tharakasal2006@gmail.com"},
  {first:"Thisara", last:"Madhushanka", email:"gathisaramadusanka@gmail.com"},
  {first:"Thushita", last:"Herath Pathiranage", email:"thushithal@live.com"},
  {first:"Tombari", last:"James", email:"tombarijames@gmail.com"},
  {first:"Vaischnavan", last:"Vigneswaran", email:"vaischt@icloud.com"},
  {first:"Vishv", last:"Shah", email:"vishvshah07@gmail.com"},
  {first:"Wimal Chanaka", last:"Udagara", email:"chanakaurwq@gmail.com"},
  {first:"Yaasin", last:"Mohamed", email:"yaasmohamed@gmail.com"},
  {first:"Yahya", last:"Nuur", email:"gorgor4466@gmail.com"},
];

const PEOPLE_MAP = new Map(
  PEOPLE
    .filter(p => p.email)
    .map(p => [p.email.toLowerCase().trim(), `${(p.first||"").trim()} ${(p.last||"").trim()}`.trim()])
);

/** =========================
 *  IndexedDB — missortsHub
 *  ========================= */
const DB_NAME = "missortsHub";
const DB_VER = 1;
const STORE = "snapshots"; // keyPath: date (YYYY-MM-DD)
let db = null;

function setStatus(msg){ document.getElementById("status").textContent = msg; }
function fmtInt(n){ return (Number(n)||0).toLocaleString("en-GB"); }
function fmtPct(x){ return isFinite(x) ? (x*100).toFixed(3) + "%" : "—"; }
function clampStr(s){ return (s ?? "").toString().trim(); }

function setLastUpdated(isoString){
  const el = document.getElementById("lastUpdated");
  if (!isoString){ el.textContent = "Last updated: —"; return; }
  const d = new Date(isoString);
  el.textContent = isFinite(d.getTime())
    ? `Last updated: ${d.toLocaleString("en-GB", { hour12:false })}`
    : "Last updated: —";
}

function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e) => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains(STORE)){
        d.createObjectStore(STORE, { keyPath: "date" });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function putSnapshot(date, rows){
  return new Promise((resolve, reject) => {
    const tx = db.transaction([STORE], "readwrite");
    tx.objectStore(STORE).put({ date, rows, savedAt: new Date().toISOString() });
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

function getSnapshot(date){
  return new Promise((resolve, reject) => {
    const tx = db.transaction([STORE], "readonly");
    const req = tx.objectStore(STORE).get(date);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}

function getAllDates(){
  return new Promise((resolve, reject) => {
    const tx = db.transaction([STORE], "readonly");
    const store = tx.objectStore(STORE);
    const dates = [];
    const req = store.openCursor();
    req.onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor){ dates.push(cursor.key); cursor.continue(); }
      else { dates.sort(); resolve(dates); }
    };
    req.onerror = () => reject(req.error);
  });
}

function wipeAll(){
  return new Promise((resolve, reject) => {
    const tx = db.transaction([STORE], "readwrite");
    tx.objectStore(STORE).clear();
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

/** =========================
 *  ISO week helpers
 *  ========================= */
function toISODateStr(d){
  const z = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const yyyy = z.getUTCFullYear();
  const mm = String(z.getUTCMonth()+1).padStart(2,"0");
  const dd = String(z.getUTCDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function isoWeek(date){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return { year: d.getUTCFullYear(), week: weekNo };
}
function weekKeyFromDateStr(dateStr){
  const d = new Date(dateStr + "T00:00:00Z");
  const w = isoWeek(d);
  return `${w.year}-W${String(w.week).padStart(2,"0")}`;
}

/** =========================
 *  Data normalisation
 *  ========================= */
const REQUIRED = [
  "Date","Week","operative",
  "Error 1 - Estimate","Error 2","Error 3","Error 4","Error 5",
  "Total Parcels"
];

function normaliseHeader(h){ return clampStr(h).replace(/\s+/g," ").trim(); }

function parseNumber(v){
  if (v === null || v === undefined) return 0;
  const s = String(v).replace(/,/g,"").trim();
  const n = Number(s);
  return isFinite(n) ? n : 0;
}

function coerceDateStr(v){
  const s = clampStr(v);
  if (!s) return null;
  if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10);

  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (m){
    const a = Number(m[1]), b = Number(m[2]), y = Number(m[3]);
    let dd, mm;
    if (a > 12){ dd=a; mm=b; }
    else if (b > 12){ dd=b; mm=a; }
    else { dd=a; mm=b; } // UK default
    const d = new Date(Date.UTC(y, mm-1, dd));
    return toISODateStr(new Date(d));
  }
  const d = new Date(s);
  if (isFinite(d.getTime())) return toISODateStr(d);
  return null;
}

/** =========================
 *  Thresholds
 *  ========================= */
let THRESH = { wcMax: 0.005, goodMax: 0.01 };
function bandFor(p){
  if (!isFinite(p)) return "Poor";
  if (p <= THRESH.wcMax) return "World Class";
  if (p <= THRESH.goodMax) return "Good";
  return "Poor";
}
function bandClass(b){
  if (b === "World Class") return "wc";
  if (b === "Good") return "good";
  return "poor";
}

/** =========================
 *  Operative display helpers
 *  ========================= */
function resolveDisplay(emailOrId){
  const key = clampStr(emailOrId).toLowerCase();
  const nm = PEOPLE_MAP.get(key);
  if (!nm) return { display: key || "—", email: key || "" };
  return { display: nm, email: key };
}

/** =========================
 *  Aggregations
 *  ========================= */
function aggregateByOperative(rows){
  // aggregate by email/id key, but keep a display label for UI
  const map = new Map(); // key -> agg
  for (const r of rows){
    const opKey = clampStr(r.operative_key || r.operative).toLowerCase();
    if (!opKey) continue;

    const opDisp = clampStr(r.operative_display) || resolveDisplay(opKey).display;

    const e1 = parseNumber(r["Error 1 - Estimate"]);
    const e2 = parseNumber(r["Error 2"]);
    const e3 = parseNumber(r["Error 3"]);
    const e4 = parseNumber(r["Error 4"]);
    const e5 = parseNumber(r["Error 5"]);
    const parcels = parseNumber(r["Total Parcels"]);

    const cur = map.get(opKey) || { operativeKey: opKey, operative: opDisp, e1:0,e2:0,e3:0,e4:0,e5:0, parcels:0 };
    // if display becomes available later, keep the nicer one
    if (cur.operative === cur.operativeKey && opDisp !== cur.operativeKey) cur.operative = opDisp;

    cur.e1 += e1; cur.e2 += e2; cur.e3 += e3; cur.e4 += e4; cur.e5 += e5; cur.parcels += parcels;
    map.set(opKey, cur);
  }

  const arr = [];
  for (const v of map.values()){
    const totalErrors = v.e1+v.e2+v.e3+v.e4+v.e5;
    const missort = v.parcels > 0 ? totalErrors / v.parcels : NaN;
    const band = bandFor(missort);
    arr.push({ ...v, totalErrors, missort, band });
  }
  return arr;
}

function totalsFromAgg(agg){
  let parcels=0, errors=0;
  let e1=0,e2=0,e3=0,e4=0,e5=0;
  for (const r of agg){
    parcels += r.parcels;
    errors += r.totalErrors;
    e1 += r.e1; e2 += r.e2; e3 += r.e3; e4 += r.e4; e5 += r.e5;
  }
  const missort = parcels > 0 ? errors / parcels : NaN;
  return { parcels, errors, missort, e1,e2,e3,e4,e5 };
}

function topN(agg, keyFn, n=10, desc=true){
  const a = agg.slice().filter(x => isFinite(keyFn(x)));
  a.sort((x,y) => desc ? (keyFn(y)-keyFn(x)) : (keyFn(x)-keyFn(y)));
  return a.slice(0,n);
}

/** =========================
 *  Repeat offenders (with error pattern)
 *  ========================= */
function repeatOffenders(dayRows){
  // daily aggregate per op/date with error breakdown
  const daily = new Map(); // opKey||date -> totals
  for (const r of dayRows){
    const opKey = clampStr(r.operative_key || r.operative).toLowerCase();
    const date = clampStr(r.Date);
    if (!opKey || !date) continue;

    const e1 = parseNumber(r["Error 1 - Estimate"]);
    const e2 = parseNumber(r["Error 2"]);
    const e3 = parseNumber(r["Error 3"]);
    const e4 = parseNumber(r["Error 4"]);
    const e5 = parseNumber(r["Error 5"]);
    const p  = parseNumber(r["Total Parcels"]);

    const k = opKey + "||" + date;
    const cur = daily.get(k) || { opKey, date, e1:0,e2:0,e3:0,e4:0,e5:0, parcels:0 };
    cur.e1 += e1; cur.e2 += e2; cur.e3 += e3; cur.e4 += e4; cur.e5 += e5; cur.parcels += p;
    daily.set(k, cur);
  }

  const perOp = new Map();
  for (const rec of daily.values()){
    const totalErrors = rec.e1+rec.e2+rec.e3+rec.e4+rec.e5;
    const miss = rec.parcels > 0 ? totalErrors / rec.parcels : NaN;
    const band = bandFor(miss);

    const { display } = resolveDisplay(rec.opKey);

    const cur = perOp.get(rec.opKey) || {
      operativeKey: rec.opKey,
      operative: display,
      poorDays: 0,
      daysPresent: 0,
      avgMissAccum: 0,
      avgMissN: 0,
      worstDay: -Infinity,
      pe1:0,pe2:0,pe3:0,pe4:0,pe5:0
    };

    cur.daysPresent += 1;
    if (isFinite(miss)){
      cur.avgMissAccum += miss;
      cur.avgMissN += 1;
      cur.worstDay = Math.max(cur.worstDay, miss);
    }

    if (band === "Poor"){
      cur.poorDays += 1;
      cur.pe1 += rec.e1; cur.pe2 += rec.e2; cur.pe3 += rec.e3; cur.pe4 += rec.e4; cur.pe5 += rec.e5;
    }

    perOp.set(rec.opKey, cur);
  }

  const out = [];
  for (const x of perOp.values()){
    if (x.poorDays < 1) continue;

    const avgMiss = x.avgMissN ? x.avgMissAccum / x.avgMissN : NaN;

    const errPairs = [
      ["E1", x.pe1],
      ["E2", x.pe2],
      ["E3", x.pe3],
      ["E4", x.pe4],
      ["E5", x.pe5],
    ].sort((a,b)=>b[1]-a[1]);

    const dominant = errPairs[0][1] > 0 ? errPairs[0][0] : "—";
    const pattern = errPairs
      .filter(p=>p[1]>0)
      .slice(0,2)
      .map(p=>`${p[0]}:${fmtInt(p[1])}`)
      .join("  ");

    out.push({
      operativeKey: x.operativeKey,
      operative: x.operative,
      poorDays: x.poorDays,
      daysPresent: x.daysPresent,
      avgMissort: avgMiss,
      worstDay: x.worstDay,
      dominantError: dominant,
      errorPattern: pattern || "—",
      pe1:x.pe1, pe2:x.pe2, pe3:x.pe3, pe4:x.pe4, pe5:x.pe5
    });
  }

  out.sort((a,b) => (b.poorDays - a.poorDays) || (b.worstDay - a.worstDay));
  return out;
}

/** =========================
 *  Rendering core dashboard
 *  ========================= */
function renderKPIs(t, viewMode, selectedDate, selectedWeek){
  const title = document.getElementById("kpiTitle");
  const sub = document.getElementById("kpiSubtitle");

  if (viewMode === "day"){
    title.textContent = "Day KPIs";
    sub.textContent = selectedDate ? `Date: ${selectedDate}` : "Date: —";
  } else {
    title.textContent = "Week KPIs";
    sub.textContent = selectedWeek ? `Week: ${selectedWeek}` : "Week: —";
  }

  const row = document.getElementById("kpiRow");
  row.innerHTML = "";

  const labelSuffix = viewMode === "day" ? "(day)" : "(week)";
  const cards = [
    { label:`Total Parcels ${labelSuffix}`, value: fmtInt(t.parcels), small:"Σ parcels" },
    { label:`Total Errors ${labelSuffix}`, value: fmtInt(t.errors), small:"Σ (E1..E5)" },
    { label:`Missort % ${labelSuffix}`, value: fmtPct(t.missort), small:"errors / parcels" }
  ];

  for (const c of cards){
    const el = document.createElement("div");
    el.className = "kpi";
    el.style.minWidth = "260px";
    el.innerHTML = `
      <div>
        <div class="label">${c.label}</div>
        <div class="value">${c.value}</div>
      </div>
      <div class="small">${c.small}</div>
    `;
    row.appendChild(el);
  }
}

function renderErrorBreakdown(t){
  const box = document.getElementById("errorBreakdown");
  box.innerHTML = "";
  const items = [
    ["Error 1s", t.e1],
    ["Error 2s", t.e2],
    ["Error 3s", t.e3],
    ["Error 4s", t.e4],
    ["Error 5s", t.e5],
  ];
  for (const [k,v] of items){
    const el = document.createElement("div");
    el.className = "pill";
    el.innerHTML = `${k}: <b>${fmtInt(v)}</b>`;
    box.appendChild(el);
  }
}

function renderWorstBest(worst, best){
  document.getElementById("worstTable").innerHTML = renderPerfTable(worst);
  document.getElementById("bestTable").innerHTML = renderPerfTable(best);
}

function renderPerfTable(rows){
  return `
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="stickyCol">Operative</th>
            <th class="right">E1</th><th class="right">E2</th><th class="right">E3</th><th class="right">E4</th><th class="right">E5</th>
            <th class="right">Parcels</th><th class="right">Total Errors</th><th class="right">Missort %</th><th>Band</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td class="stickyCol">${escapeHTML(r.operative)}</td>
              <td class="num">${fmtInt(r.e1)}</td>
              <td class="num">${fmtInt(r.e2)}</td>
              <td class="num">${fmtInt(r.e3)}</td>
              <td class="num">${fmtInt(r.e4)}</td>
              <td class="num">${fmtInt(r.e5)}</td>
              <td class="num">${fmtInt(r.parcels)}</td>
              <td class="num">${fmtInt(r.totalErrors)}</td>
              <td class="num">${fmtPct(r.missort)}</td>
              <td><span class="band ${bandClass(r.band)}">${r.band}</span></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}

function renderErrorTopTables(agg){
  const mk = (errKey) => {
    const top = topN(agg, r => r[errKey], 10, true);
    return `
      <div class="tableWrap">
        <table>
          <thead>
            <tr><th class="stickyCol">Operative</th><th class="right">Error Count</th><th class="right">Total Parcels</th><th class="right">Missort %</th></tr>
          </thead>
          <tbody>
            ${top.map(r => `
              <tr>
                <td class="stickyCol">${escapeHTML(r.operative)}</td>
                <td class="num">${fmtInt(r[errKey])}</td>
                <td class="num">${fmtInt(r.parcels)}</td>
                <td class="num">${fmtPct(r.missort)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
  };
  document.getElementById("e1Table").innerHTML = mk("e1");
  document.getElementById("e2Table").innerHTML = mk("e2");
  document.getElementById("e3Table").innerHTML = mk("e3");
  document.getElementById("e4Table").innerHTML = mk("e4");
  document.getElementById("e5Table").innerHTML = mk("e5");
}

function renderRepeatTable(rows){
  const top = rows.slice(0, 50);
  document.getElementById("repeatTable").innerHTML = `
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="stickyCol">Operative</th>
            <th class="right">Poor Days</th>
            <th class="right">Days Present</th>
            <th class="right">Avg Missort %</th>
            <th class="right">Worst Day %</th>
            <th>Dominant Error</th>
            <th>Error Pattern (poor days)</th>
            <th class="right">E1</th>
            <th class="right">E2</th>
            <th class="right">E3</th>
            <th class="right">E4</th>
            <th class="right">E5</th>
          </tr>
        </thead>
        <tbody>
          ${top.map(r => `
            <tr>
              <td class="stickyCol">${escapeHTML(r.operative)}</td>
              <td class="num">${fmtInt(r.poorDays)}</td>
              <td class="num">${fmtInt(r.daysPresent)}</td>
              <td class="num">${fmtPct(r.avgMissort)}</td>
              <td class="num">${fmtPct(r.worstDay)}</td>
              <td>${escapeHTML(r.dominantError)}</td>
              <td class="muted">${escapeHTML(r.errorPattern)}</td>
              <td class="num">${fmtInt(r.pe1)}</td>
              <td class="num">${fmtInt(r.pe2)}</td>
              <td class="num">${fmtInt(r.pe3)}</td>
              <td class="num">${fmtInt(r.pe4)}</td>
              <td class="num">${fmtInt(r.pe5)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}

function escapeHTML(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** =========================
 *  Loaders (dates/weeks)
 *  ========================= */
async function refreshSelectors(){
  const dates = await getAllDates();
  document.getElementById("datesState").textContent = `Dates: ${dates.length}`;

  const dateSel = document.getElementById("dateSelect");
  const cur = dateSel.value;
  dateSel.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join("");
  if (dates.length) dateSel.value = (cur && dates.includes(cur)) ? cur : dates[dates.length - 1];

  const weekSel = document.getElementById("weekSelect");
  const weeks = Array.from(new Set(dates.map(weekKeyFromDateStr))).sort();
  const curW = weekSel.value;
  weekSel.innerHTML = weeks.map(w => `<option value="${w}">${w}</option>`).join("");

  if (dateSel.value){
    const wk = weekKeyFromDateStr(dateSel.value);
    weekSel.value = weeks.includes(wk) ? wk : ((curW && weeks.includes(curW)) ? curW : (weeks[weeks.length - 1] || ""));
  }
}

async function getRowsForWeek(weekKey){
  const dates = await getAllDates();
  const inWeekDates = dates.filter(d => weekKeyFromDateStr(d) === weekKey);
  const all = [];
  for (const d of inWeekDates){
    const snap = await getSnapshot(d);
    if (snap && Array.isArray(snap.rows)) all.push(...snap.rows);
  }
  return all;
}

async function getRowsForDate(dateStr){
  const snap = await getSnapshot(dateStr);
  return (snap && Array.isArray(snap.rows)) ? snap.rows : [];
}

function getLatestDate(dates){ return dates.length ? dates[dates.length - 1] : null; }

function addDaysISO(days){
  const d = new Date();
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0,10);
}

function ratePerK(parcels, errors){
  return parcels > 0 ? (errors / parcels) * 1000 : 0;
}

async function rollingBaseline(todayStr, daysBack=7){
  const dates = await getAllDates();
  const idx = dates.indexOf(todayStr);
  if (idx <= 0) return null;

  const windowDates = dates.slice(Math.max(0, idx - daysBack), idx);
  const rows = [];
  for (const d of windowDates) rows.push(...await getRowsForDate(d));

  let parcels=0, e1=0,e2=0,e3=0,e4=0,e5=0, errors=0;
  for (const r of rows){
    const p = parseNumber(r["Total Parcels"]);
    const E1 = parseNumber(r["Error 1 - Estimate"]);
    const E2 = parseNumber(r["Error 2"]);
    const E3 = parseNumber(r["Error 3"]);
    const E4 = parseNumber(r["Error 4"]);
    const E5 = parseNumber(r["Error 5"]);
    parcels += p;
    e1 += E1; e2 += E2; e3 += E3; e4 += E4; e5 += E5;
    errors += (E1+E2+E3+E4+E5);
  }
  return { parcels, errors, e1,e2,e3,e4,e5, nDays: windowDates.length };
}

/** =========================
 *  "AI-like" Action Engine (no routes)
 *  ========================= */
const ACTION_CFG = {
  minParcelsForCoaching: 250,
  spikeMultiplier: 1.5,
  spikeAbsPerK: 0.75,
  repeatPoorDays: 3,
  severePoorDays: 5
};

const OWNER_DEFAULTS = {
  retrain: "Supervisor",
  coaching: "Supervisor",
  escalation: "Shift Manager",
  process_check: "Shift Manager",
  qa_audit: "Quality / Compliance",
  daily_huddle: "Shift Manager",
  data_quality: "Admin / Analyst"
};

function actionKey(a){ return `${a.type}||${a.subject}`; }

function loadActionOverrides(){
  try { return JSON.parse(localStorage.getItem("missorts_action_overrides") || "{}"); }
  catch { return {}; }
}
function saveActionOverrides(obj){
  localStorage.setItem("missorts_action_overrides", JSON.stringify(obj));
}

function renderActions(actions){
  const overrides = loadActionOverrides();

  const rows = actions.map(a => {
    const k = actionKey(a);
    const ov = overrides[k] || {};
    const owner = ov.owner ?? a.owner ?? "";
    const due = ov.due ?? a.due ?? "";

    return `
      <tr>
        <td>${escapeHTML(a.action)}</td>
        <td class="num">${escapeHTML(String(a.priority))}</td>
        <td><input class="inline" data-k="${escapeHTML(k)}" data-f="owner" value="${escapeHTML(owner)}" placeholder="Owner"></td>
        <td><input class="inline" data-k="${escapeHTML(k)}" data-f="due" type="date" value="${escapeHTML(due)}"></td>
        <td class="muted">${escapeHTML(a.reason || "")}</td>
      </tr>
    `;
  }).join("");

  document.getElementById("actionsList").innerHTML = `
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="stickyCol">Action</th>
            <th class="right">Priority</th>
            <th>Owner</th>
            <th>Due</th>
            <th>Why</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="5" class="muted">No actions generated.</td></tr>`}</tbody>
      </table>
    </div>
  `;

  document.querySelectorAll("#actionsList input").forEach(inp => {
    inp.addEventListener("change", (e) => {
      const k = e.target.getAttribute("data-k");
      const f = e.target.getAttribute("data-f");
      const v = e.target.value;

      const obj = loadActionOverrides();
      obj[k] = obj[k] || {};
      obj[k][f] = v;
      saveActionOverrides(obj);
    });
  });
}

function scoreAction(a){
  const base = a.priority * 100;
  const sev = Number(a.severity || 0);
  return base - sev;
}

async function generateActionsForToday(){
  const dates = await getAllDates();
  const today = getLatestDate(dates);
  if (!today) return [];

  const todayRows = await getRowsForDate(today);
  const todayAgg = aggregateByOperative(todayRows);
  const todayTotals = totalsFromAgg(todayAgg);

  const base = await rollingBaseline(today, 7);
  const actions = [];

  // Data sanity
  const suspicious = todayAgg.find(r => r.totalErrors > r.parcels && r.parcels > 0);
  if (todayTotals.parcels === 0 || todayRows.length === 0){
    actions.push({
      type:"data_quality",
      subject:"No data",
      priority:1,
      severity:100,
      action:`Fix data feed — latest saved date has no usable rows/parcels`,
      owner: OWNER_DEFAULTS.data_quality,
      due: addDaysISO(0),
      reason:`No rows or total parcels = 0 for latest date (${today}). Check RAW_DUMP publish/export.`
    });
    return actions.slice(0,5);
  }
  if (suspicious){
    actions.push({
      type:"data_quality",
      subject:"Outliers",
      priority:2,
      severity:60,
      action:`Validate RAW_DUMP — found impossible values (errors > parcels)`,
      owner: OWNER_DEFAULTS.data_quality,
      due: addDaysISO(0),
      reason:`Example: ${suspicious.operative} has ${suspicious.totalErrors} errors on ${suspicious.parcels} parcels.`
    });
  }

  // Repeat offenders over last 7 available dates (incl today)
  const idx = dates.indexOf(today);
  const windowDates = dates.slice(Math.max(0, idx - 6), idx + 1);
  const windowRows = [];
  for (const d of windowDates) windowRows.push(...await getRowsForDate(d));
  const repeat = repeatOffenders(windowRows);

  // Retrain trigger
  repeat.filter(x => x.poorDays >= ACTION_CFG.repeatPoorDays).slice(0,3).forEach(r => {
    actions.push({
      type:"retrain",
      subject:r.operativeKey,
      priority:1,
      severity: Math.min(100, r.poorDays * 15),
      action:`Retrain / re-brief ${r.operative} — repeat poor performance`,
      owner: OWNER_DEFAULTS.retrain,
      due: addDaysISO(2),
      reason:`${r.poorDays} poor days in last ${windowDates.length} days. Pattern: ${r.errorPattern} (dominant ${r.dominantError}).`
    });
  });

  // Escalation trigger
  repeat.filter(x => x.poorDays >= ACTION_CFG.severePoorDays).slice(0,2).forEach(r => {
    actions.push({
      type:"escalation",
      subject:r.operativeKey,
      priority:1,
      severity: 95,
      action:`Escalate performance plan for ${r.operative} (PIP / remove from critical tasks)`,
      owner: OWNER_DEFAULTS.escalation,
      due: addDaysISO(1),
      reason:`Severe: ${r.poorDays} poor days in last ${windowDates.length}. Pattern: ${r.errorPattern}.`
    });
  });

  // Today worst coaching (volume-aware)
  const worstToday = topN(todayAgg.filter(x=>x.parcels>0), r => r.missort, 5, true).slice(0,2);
  for (const w of worstToday){
    if (w.parcels < ACTION_CFG.minParcelsForCoaching){
      actions.push({
        type:"coaching",
        subject:w.operativeKey,
        priority:3,
        severity: 20,
        action:`Validate before coaching — ${w.operative} is high % on low volume today (${fmtInt(w.parcels)} parcels)`,
        owner: OWNER_DEFAULTS.coaching,
        due: "",
        reason:`Low parcels makes missort% noisy. Observe process + re-check next shift.`
      });
    } else {
      actions.push({
        type:"coaching",
        subject:w.operativeKey,
        priority:2,
        severity: Math.min(80, w.missort*10000),
        action:`Targeted coaching for ${w.operative} — focus on dominant errors today`,
        owner: OWNER_DEFAULTS.coaching,
        due: addDaysISO(1),
        reason:`Today missort ${fmtPct(w.missort)} on ${fmtInt(w.parcels)} parcels (errors ${fmtInt(w.totalErrors)}). Biggest counts: E2 ${fmtInt(w.e2)}, E1 ${fmtInt(w.e1)}, E4 ${fmtInt(w.e4)}.`
      });
    }
  }

  // Error spikes vs baseline (per 1k parcels)
  if (base && base.parcels > 0){
    const todayRates = {
      e1: ratePerK(todayTotals.parcels, todayTotals.e1),
      e2: ratePerK(todayTotals.parcels, todayTotals.e2),
      e3: ratePerK(todayTotals.parcels, todayTotals.e3),
      e4: ratePerK(todayTotals.parcels, todayTotals.e4),
      e5: ratePerK(todayTotals.parcels, todayTotals.e5),
      miss: ratePerK(todayTotals.parcels, todayTotals.errors),
    };
    const baseRates = {
      e1: ratePerK(base.parcels, base.e1),
      e2: ratePerK(base.parcels, base.e2),
      e3: ratePerK(base.parcels, base.e3),
      e4: ratePerK(base.parcels, base.e4),
      e5: ratePerK(base.parcels, base.e5),
      miss: ratePerK(base.parcels, base.errors),
    };

    function maybeSpike(key, label){
      const t = todayRates[key], b = baseRates[key];
      if (b <= 0) return;
      const mult = t / b;
      const abs = t - b;
      if (mult >= ACTION_CFG.spikeMultiplier && abs >= ACTION_CFG.spikeAbsPerK){
        const uplift = (mult - 1) * 100;
        const topContrib = topN(todayAgg, r => r[key], 3, true).filter(x=>x[key]>0).map(x=>x.operative);
        actions.push({
          type:"process_check",
          subject:label,
          priority:1,
          severity: Math.min(90, uplift),
          action:`Investigate ${label} spike — check process controls + brief floor`,
          owner: OWNER_DEFAULTS.process_check,
          due: addDaysISO(1),
          reason:`${label}/1k today ${t.toFixed(2)} vs baseline ${b.toFixed(2)} (+${uplift.toFixed(0)}%). Top contributors: ${topContrib.join(", ") || "n/a"}.`
        });
      }
    }

    maybeSpike("e1", "Error 1");
    maybeSpike("e2", "Error 2");
    maybeSpike("e3", "Error 3");
    maybeSpike("e4", "Error 4");
    maybeSpike("e5", "Error 5");

    // Overall spike huddle
    if (baseRates.miss > 0 && (todayRates.miss/baseRates.miss) >= 1.35 && (todayRates.miss-baseRates.miss) >= 0.75){
      const uplift = ((todayRates.miss/baseRates.miss)-1)*100;
      actions.push({
        type:"daily_huddle",
        subject:"Overall missorts",
        priority:1,
        severity: Math.min(95, uplift),
        action:`Run 10-min quality huddle — missorts are up vs baseline`,
        owner: OWNER_DEFAULTS.daily_huddle,
        due: addDaysISO(0),
        reason:`Missorts/1k today ${todayRates.miss.toFixed(2)} vs baseline ${baseRates.miss.toFixed(2)} (+${uplift.toFixed(0)}%).`
      });
    }
  }

  // Concentration audit (example on E4)
  const totalE4 = todayTotals.e4;
  if (totalE4 > 0){
    const topE4 = topN(todayAgg, r => r.e4, 1, true)[0];
    if (topE4 && topE4.e4 / totalE4 >= 0.35 && topE4.e4 >= 5){
      actions.push({
        type:"qa_audit",
        subject:`E4||${topE4.operativeKey}`,
        priority:2,
        severity: 70,
        action:`QA spot-audit ${topE4.operative} handling — concentrated Error 4`,
        owner: OWNER_DEFAULTS.qa_audit,
        due: addDaysISO(1),
        reason:`${topE4.operative} accounts for ${(topE4.e4/totalE4*100).toFixed(0)}% of today’s Error 4 (${fmtInt(topE4.e4)}/${fmtInt(totalE4)}).`
      });
    }
  }

  // De-dupe + rank
  const seen = new Set();
  const deduped = [];
  for (const a of actions){
    const k = actionKey(a);
    if (seen.has(k)) continue;
    seen.add(k);
    deduped.push(a);
  }
  deduped.sort((a,b)=> scoreAction(a) - scoreAction(b));
  return deduped.slice(0,5);
}

/** =========================
 *  Validation & normalisation
 *  ========================= */
function validateAndNormaliseRows(rows){
  const norm = rows.map(r => {
    const out = {};
    for (const k in r) out[normaliseHeader(k)] = r[k];
    return out;
  });

  const cols = new Set(Object.keys(norm[0] || {}));
  const missing = REQUIRED.filter(c => !cols.has(c));
  if (missing.length) throw new Error("Missing columns: " + missing.join(", "));

  const cleaned = [];
  for (const r of norm){
    const date = coerceDateStr(r.Date);
    if (!date) continue;

    const rawOp = clampStr(r.operative).toLowerCase();
    const { display } = resolveDisplay(rawOp);

    cleaned.push({
      Date: date,
      Week: parseNumber(r.Week),
      operative_key: rawOp,          // stable key (email/id)
      operative_display: display,    // nice label
      operative: rawOp,              // keep original too
      "Error 1 - Estimate": parseNumber(r["Error 1 - Estimate"]),
      "Error 2": parseNumber(r["Error 2"]),
      "Error 3": parseNumber(r["Error 3"]),
      "Error 4": parseNumber(r["Error 4"]),
      "Error 5": parseNumber(r["Error 5"]),
      "Total Parcels": parseNumber(r["Total Parcels"])
    });
  }
  if (!cleaned.length) throw new Error("No usable rows found after cleaning (check Date format and headers).");
  return cleaned;
}

/** =========================
 *  Load from Google Sheet (Published CSV) + Save history
 *  ========================= */
async function loadFromGSheetAndSave(){
  setStatus("Fetching RAW_DUMP from Google Sheet…");
  const res = await fetch(PUBLISHED_CSV_URL, { cache: "no-store" });
  if (!res.ok) throw new Error(`Fetch failed (${res.status})`);

  const csvText = await res.text();
  const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
  const cleaned = validateAndNormaliseRows(parsed);

  const byDate = new Map();
  for (const r of cleaned){
    const d = r.Date;
    const cur = byDate.get(d) || [];
    cur.push(r);
    byDate.set(d, cur);
  }

  setStatus(`Saving ${byDate.size} date(s) from GSheet…`);
  for (const [date, dayRows] of byDate.entries()){
    await putSnapshot(date, dayRows);
  }

  const nowIso = new Date().toISOString();
  localStorage.setItem("missorts_last_updated", nowIso);
  setLastUpdated(nowIso);

  const dates = await getAllDates();
  if (dates.length){
    const last = dates[dates.length - 1];
    document.getElementById("dateSelect").value = last;
    document.getElementById("weekSelect").value = weekKeyFromDateStr(last);
  }

  setStatus(`Loaded + saved ${cleaned.length} rows across ${byDate.size} date(s).`);
}

/** =========================
 *  Main render (Day view vs Week view)
 *  ========================= */
async function render(){
  await refreshSelectors();

  const viewMode = document.getElementById("viewMode").value;
  const selectedDate = document.getElementById("dateSelect").value;
  const selectedWeek = document.getElementById("weekSelect").value;

  const rows = (viewMode === "day")
    ? (selectedDate ? await getRowsForDate(selectedDate) : [])
    : (selectedWeek ? await getRowsForWeek(selectedWeek) : []);

  document.getElementById("rowsState").textContent =
    `Rows (${viewMode === "day" ? "selected day" : "selected week"}): ${rows.length}`;

  const agg = aggregateByOperative(rows);
  const totals = totalsFromAgg(agg);

  renderKPIs(totals, viewMode, selectedDate, selectedWeek);
  renderErrorBreakdown(totals);

  // band counts
  const counts = { poor:0, good:0, wc:0 };
  for (const r of agg){
    if (r.band === "World Class") counts.wc++;
    else if (r.band === "Good") counts.good++;
    else counts.poor++;
  }
  const kpiRow = document.getElementById("kpiRow");
  const cEl = document.createElement("div");
  cEl.className = "kpi";
  cEl.style.minWidth = "360px";
  cEl.innerHTML = `
    <div>
      <div class="label">Performer Bands (${viewMode === "day" ? "day" : "week"})</div>
      <div class="row" style="margin-top:6px">
        <span class="pill"><span class="wcText">World Class</span>: <b>${counts.wc}</b></span>
        <span class="pill"><span class="goodText">Good</span>: <b>${counts.good}</b></span>
        <span class="pill"><span class="dangerText">Poor</span>: <b>${counts.poor}</b></span>
      </div>
    </div>
    <div class="small">counts of operatives</div>
  `;
  kpiRow.appendChild(cEl);

  const filtered = agg.filter(r => r.parcels > 0);
  const worst = topN(filtered, r => r.missort, 10, true);
  const best  = topN(filtered, r => r.missort, 10, false);
  renderWorstBest(worst, best);

  renderErrorTopTables(agg);

  // Repeat offenders window should match the current view:
  // - day view: show repeat offenders for the ISO week of that selected date (so it still makes sense)
  // - week view: show repeat offenders for that selected week
  let repeatRows = rows;
  if (viewMode === "day" && selectedDate){
    const wk = weekKeyFromDateStr(selectedDate);
    repeatRows = await getRowsForWeek(wk);
  }
  const repeat = repeatOffenders(repeatRows);
  renderRepeatTable(repeat);

  // Actions (always based on latest date)
  const actions = await generateActionsForToday();
  renderActions(actions);
}

/** =========================
 *  Init
 *  ========================= */
(async function init(){
  setStatus("Opening local database…");
  try{
    db = await openDB();
    document.getElementById("dbState").textContent = `DB: OK (${DB_NAME})`;
    setStatus("Ready.");
  } catch(e){
    document.getElementById("dbState").textContent = "DB: ERROR";
    setStatus("IndexedDB failed. Try Chrome/Edge and disable private mode.");
    return;
  }

  document.getElementById("thresholdState").textContent =
    `Thresholds: WC ≤ ${THRESH.wcMax}, Good ≤ ${THRESH.goodMax}`;

  setLastUpdated(localStorage.getItem("missorts_last_updated"));

  await refreshSelectors();
  await render();

  document.getElementById("btnLoadSheet").addEventListener("click", async () => {
    try{
      await loadFromGSheetAndSave();
      // after load, default to DAY view of latest date
      document.getElementById("viewMode").value = "day";
      await render();
      setStatus("Ready.");
    } catch(e){
      console.error(e);
      setStatus("Load failed: " + (e?.message || e));
    }
  });

  document.getElementById("btnRefresh").addEventListener("click", async () => {
    setStatus("Refreshing…");
    await render();
    setStatus("Ready.");
  });

  document.getElementById("viewMode").addEventListener("change", async () => {
    setStatus("View mode changed → refreshed view.");
    await render();
    setStatus("Ready.");
  });

  document.getElementById("dateSelect").addEventListener("change", async (e) => {
    const d = e.target.value;
    if (d) document.getElementById("weekSelect").value = weekKeyFromDateStr(d);
    document.getElementById("viewMode").value = "day";
    setStatus("Date changed → Day view.");
    await render();
    setStatus("Ready.");
  });

  document.getElementById("weekSelect").addEventListener("change", async () => {
    document.getElementById("viewMode").value = "week";
    setStatus("Week changed → Week view.");
    await render();
    setStatus("Ready.");
  });

  document.getElementById("btnWipe").addEventListener("click", async () => {
    const ok = confirm("Wipe ALL saved history from this browser? This cannot be undone.");
    if (!ok) return;
    await wipeAll();
    localStorage.removeItem("missorts_last_updated");
    localStorage.removeItem("missorts_action_overrides");
    setLastUpdated(null);
    setStatus("All saved data wiped.");
    await render();
    setStatus("Ready.");
  });
})();
</script>
</body>
</html>
